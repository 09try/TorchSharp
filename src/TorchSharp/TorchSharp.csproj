<Project>
  <!-- Implicit top import -->
  <Import Project="Sdk.props" Sdk="Microsoft.NET.Sdk" />

  <PropertyGroup>
      <TargetFrameworks>netstandard2.0</TargetFrameworks>
      <IncludeInPackage>TorchSharp</IncludeInPackage>
      <AllowUnsafeBlocks>true</AllowUnsafeBlocks>
      <UseMLCodeAnalyzer>false</UseMLCodeAnalyzer>
      <UseStyleCopAnalyzer>false</UseStyleCopAnalyzer>
      <IsPackable>false</IsPackable>
  </PropertyGroup>

  <ItemGroup>
    <None Remove="Tensor\TorchTensorTyped.tt" />
  </ItemGroup>

  <ItemGroup>
    <Content Include="Tensor\TorchTensorTyped.tt">
      <Generator>TextTemplatingFileGenerator</Generator>
      <LastGenOutput>TorchTensorTyped.generated.cs</LastGenOutput>
    </Content>
  </ItemGroup>

  <ItemGroup>
    <PackageReference Include="System.Memory" Version="$(SystemMemoryVersion)" />
  </ItemGroup>

  <ItemGroup>
    <Service Include="{508349b6-6b84-4df5-91f0-309beebad82d}" />
  </ItemGroup>

  <ItemGroup>
    <Compile Update="Tensor\TorchTensorTyped.generated.cs">
      <DesignTime>True</DesignTime>
      <AutoGen>True</AutoGen>
      <DependentUpon>TorchTensorTyped.tt</DependentUpon>
    </Compile>
  </ItemGroup>


  <PropertyGroup>
      <PackDependsOn>
          $(PackDependsOn);
          RealPack
      </PackDependsOn>
  </PropertyGroup>


  <Import Project="Sdk.targets" Sdk="Microsoft.NET.Sdk" />

 <!-- This is an odd place to trigger the download of the redist bits and the build of the C++ project -->
 <!--     1. the Redist download projects use .proj which is not recognised in Visual Studio or 'dotnet build' on TorchSharp.sln  --> 
 <!--     2. the C++ project uses a generated project file under Release/Debug also not recognised in TorchSharp.sln --> 
 this is an odd place to trigger the download of the redist bits and the build of the C++ project -->
  <Target Name="BeforeBuild">
    <Message Importance="High" Text="Using VersionSuffix = $(VersionSuffix)" />
    <MSBuild Projects="..\Redist\LibTorch.Cuda.$(CudaVersionDot).Redist\LibTorch.Cuda.$(CudaVersionDot).Redist.proj" 
             Condition="'$(BuildingInsideVisualStudio)'!='true' AND '$(SkipNative)' != 'true'  AND '$(SkipCuda)' != 'true'" 
             Targets="Build" />

    <MSBuild Projects="..\Redist\LibTorch.Redist\LibTorch.Redist.proj" 
            Condition="'$(BuildingInsideVisualStudio)'!='true' AND '$(SkipNative)' != 'true'" 
            Targets="Build" />

    <MSBuild Projects="..\Native\build.proj" 
            Condition="'$(BuildingInsideVisualStudio)'!='true' AND '$(SkipNative)' != 'true'" 
            Targets="Build" />

  </Target>

 <!-- The packaging logic - package all assets when we pack TorchSharp  -->
  <Target Name="RealPack">
    <Message Text="Restoring packaging projects..." Importance="high" />
    <MSBuild Projects="..\..\pkg\LibTorch.Cuda.$(CudaVersionDot).Redist\LibTorch.Cuda.$(CudaVersionDot).Redist.nupkgproj" Targets="Restore" />
    <MSBuild Projects="..\..\pkg\LibTorch.Redist\LibTorch.Redist.nupkgproj" Targets="Restore" />
    <MSBuild Projects="..\..\pkg\TorchSharp\TorchSharp.nupkgproj" Targets="Restore" />

    <Message Text="Packing TorchSharp nupkg..." Importance="high" />
    <MSBuild Projects="..\..\pkg\TorchSharp\TorchSharp.nupkgproj" Targets="Pack" />

    <Warning Text="Packages will be incomplete and unusable on linux platform. You build the LibTorchSharp.so binaries on other platforms and copy them into '$(PackageAssetsPath)' to make complete packages. This is automated by Azure Pipelines." 
             Condition="!Exists('$(PackageAssetsPath)\LibTorch.Redist\runtimes\linux-x64\native\libLibTorchSharp.so')
                     OR !Exists('$(PackageAssetsPath)\LibTorch.Cuda.$(CudaVersionDot).Redist\runtimes\linux-x64\native\libLibTorchSharp.so')
                     " />
    <Warning Text="Packages will be incomplete and unusable on win-x64 platform. You build the LibTorchSharp.so binaries on other platforms and copy them into '$(PackageAssetsPath)' to make complete packages. This is automated by Azure Pipelines." 
             Condition="!Exists('$(PackageAssetsPath)\LibTorch.Redist\runtimes\win-x64\native\libLibTorchSharp.so')
                     OR !Exists('$(PackageAssetsPath)\LibTorch.Cuda.$(CudaVersionDot).Redist\runtimes\win-x64\native\libLibTorchSharp.so')
                     " />

    <Message Text="Packing LibTorch.Cuda.$(CudaVersionDot).Redist nupkg (takes a long time!)..." Importance="high"  Condition="'$(SkipNative)' != 'true' AND '$(SkipCuda)' != 'true' "  />
    <MSBuild Projects="..\..\pkg\LibTorch.Cuda.$(CudaVersionDot).Redist\LibTorch.Cuda.$(CudaVersionDot).Redist.nupkgproj" Targets="Pack"  Condition="'$(SkipNative)' != 'true' AND '$(SkipCuda)' != 'true' " />

    <Message Text="Packing LibTorch.Redist nupkg..." Importance="high"  Condition="'$(SkipNative)' != 'true'" />
    <MSBuild Projects="..\..\pkg\LibTorch.Redist\LibTorch.Redist.nupkgproj" Targets="Pack"  Condition="'$(SkipNative)' != 'true'" />

    <Message Text="Done packing!" Importance="high" />
  </Target>

</Project>
